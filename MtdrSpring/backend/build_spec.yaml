version: 0.1
component: build
timeoutInSeconds: 1000
shell: bash
failImmediatelyOnError: true

env:
  variables:
    "JAVA_HOME" : "/usr/lib64/graalvm/graalvm-java20"
    "IMAGE_NAME": "todolistapp-springboot"
    "DOCKER_REGISTRY": "mx-queretaro-1.ocir.io/axcioc1wifb3/reacttodo/gw5ok"

  exportedVariables:
    - BuildServiceVersion

steps:
  - type: Command
    name: Install the latest Oracle GraalVM for JDK 20 - JDK and Native Image
    command: |
      yum -y install graalvm-20-native-image
  
  - type: Command
    name: Set the PATH here
    command: |
      export PATH=$JAVA_HOME/bin:$PATH  

  - type: Command
    name: Compile
    command: mvn -f /workspace/Botacle/MtdrSpring/backend/pom.xml compile

  - type: Command
    name: Package
    command: mvn -f /workspace/Botacle/MtdrSpring/backend/pom.xml clean package spring-boot:repackage

  - type: Command
    name: Check
    command: ls -la target/

  - type: Command
    name: Dockerize
    command: |
      BuildServiceVersion=`echo ${OCI_BUILD_RUN_ID} | rev | cut -c 1-7`
      echo $BuildServiceVersion
      docker build -t $IMAGE_NAME .
        

outputArtifacts:
  - name: todoArtifact
    type: BINARY
    location: /workspace/Botacle/MtdrSpring/backend/target/MyTodoList.jar

  - name: todoDockerImage
    type: DOCKER_IMAGE
    location: $IMAGE_NAME

